name: CI/CD to Localhost

on:
  push:
    branches: [main]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Run Unit Tests
        run: mvn test
          

  build-images:
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker images
        run: |
          echo "Building Docker images..."
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          # docker build -t payment-service ./payment-service
          # docker build -t order-service ./order-service
          echo "Images built successfully! ‚úÖ"

  deploy-to-local:
    needs: build-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Localhost
        run: |
          echo "üöÄ Starting deployment to localhost..."
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker-compose down || true
          
          # Pull latest images (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker Hub)
          docker-compose pull || true
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É
          docker-compose up -d
          
          # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
          sleep 30
          
          echo "‚úÖ Deployment completed!"
          echo "üìä Services status:"
          docker-compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints
          echo "üîç Health checks:"
          curl -f http://localhost:8080/actuator/health || echo "Payment service starting..."
          curl -f http://localhost:8081/actuator/health || echo "Order service starting..."
          curl -f http://localhost:80/ || echo "Frontend starting..."